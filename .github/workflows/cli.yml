name: Build&release

on:
  push:
    paths:
      - "**/*.rs"
      - ".github/workflows/cli.yml"
    branches:
      - main
      - dev
  pull_request:
  workflow_dispatch:
  workflow_run:
    workflows:
      - release-tag-and-backmerge.yml
    types:
      - completed

env:
  ACTIONS_ID: ${{ github.run_id }}

permissions:
  id-token: write
  attestations: write

jobs:
  test-with-httpyac:
    # allow failed
    if: false
    runs-on: ubuntu-latest
    name: test with httpyac
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: actions-rust-lang/setup-rust-toolchain@v1.15.2

      - name: Install netcat
        run: |
          if ! command -v nc &> /dev/null; then
            apt-get update && apt-get install -y netcat-openbsd
          fi

      - run: cargo b
      - run: cargo run &

      - name: Wait for server to be ready
        run: |
          for i in {1..10}; do
            if nc -z localhost 8080; then
              echo "Server is up!"
              break
            else
              echo "Waiting for server..."
              sleep 1
            fi
          done

      - name: test
        id: test
        run: npx httpyac send test/test.http -a --bail --insecure --raw

  test:
    runs-on: ubuntu-latest
    name: test
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: taiki-e/install-action@271014ec0fe73d05f4206c04b4392ad895d8f0e3 # v2.62.66
        with:
          tool: cargo-make
      - run: cargo make test

  release:
    name: Release - ${{ matrix.platform.os-name }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os-name: FreeBSD-x86_64
            runs-on: ubuntu-24.04
            target: x86_64-unknown-freebsd

          - os-name: Linux-x86_64
            runs-on: ubuntu-24.04
            target: x86_64-unknown-linux-musl

          - os-name: Linux-aarch64
            runs-on: ubuntu-24.04
            target: aarch64-unknown-linux-musl

          - os-name: Linux-riscv64
            runs-on: ubuntu-24.04
            target: riscv64gc-unknown-linux-gnu

          - os-name: Windows-x86_64
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc

          - os-name: macOS-x86_64
            runs-on: macOS-latest
            target: x86_64-apple-darwin

    runs-on: ${{ matrix.platform.runs-on }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build binary
        uses: houseabsolute/actions-rust-cross@v1
        with:
          command: build
          target: ${{ matrix.platform.target }}
          args: "--locked --release"
          strip: true

      - name: Set artifact path
        # Force bash so the append to $GITHUB_ENV behaves consistently across runners
        shell: bash
        run: |
          if [[ "${{ matrix.platform.os-name }}" == *"Windows"* ]]; then
            echo "art_path=./target/${{ matrix.platform.target }}/release/my-http-server.exe" >> $GITHUB_ENV
          else
            echo "art_path=./target/${{ matrix.platform.target }}/release/my-http-server" >> $GITHUB_ENV
          fi

      - name: Verify artifact exists
        shell: bash
        run: |
          if [[ -z "${{ env.art_path }}" ]]; then
            echo "Error: env.art_path is empty. Did the previous step set it correctly?" >&2
            exit 1
          fi
          if [[ ! -f "${{ env.art_path }}" ]]; then
            echo "Error: Artifact not found: ${{ env.art_path }}" >&2
            echo "Directory listing of target/:"
            ls -la ./target || true
            exit 1
          fi

      - name: Import GPG key
        if: ${{ env.GPG_PRIVATE_KEY != '' && env.GPG_PASSPHRASE != '' }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        # GPG signing for release artifacts - requires GPG_PRIVATE_KEY and GPG_PASSPHRASE secrets
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: GPG sign release artifacts
        if: ${{ env.GPG_PRIVATE_KEY != '' && env.GPG_PASSPHRASE != '' }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        shell: bash
        run: |
          gpg --list-secret-keys || true
          echo "Signing ${{ env.art_path }}"
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --detach-sign "${{ env.art_path }}"

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: "${{ env.art_path }}"

      - name: Publish artifacts and release
        uses: fvj/actions-rust-release@jvf/add-glob-support-to-extra-files
        id: Publish-artifacts-and-release
        with:
          executable-name: my-http-server
          target: ${{ matrix.platform.target }}
          changes-file: ""
          extra-files: |
            LICENSE.txt
            README.md
            **/*.asc
            **/*.sig
