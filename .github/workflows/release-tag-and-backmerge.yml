name: release-tag-and-backmerge

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  tag-and-backmerge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TOML Reader
        id: read_toml
        uses: SebRollen/toml-action@v1.2.0
        with:
          file: Cargo.toml
          field: package.version

      - name: Create and push tag
        env:
          VERSION: ${{ steps.read_toml.outputs.value }}
        shell: bash
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          tag="v${VERSION}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists, skipping."
          else
            echo "Creating tag $tag"
            git tag -a "$tag" -m "Release $VERSION"
            git push origin "$tag"
          fi

      - name: Back-merge main → dev via git merge
        id: backmerge
        shell: bash
        run: |
          set -e
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          # Ensure we have up-to-date refs
          git fetch origin dev main
          # Create/update local dev branch tracking origin/dev
          git checkout -B dev origin/dev
          # Try merging origin/main into dev; on conflict, abort and expose output without failing the job
          set +e
          git merge --no-ff --no-edit origin/main
          status=$?
          if [ $status -ne 0 ]; then
            echo "conflict=true" >> "$GITHUB_OUTPUT"
            git merge --abort || true
            exit 0
          fi
          set -e
          # Push only if there are new commits compared to origin/dev
          if ! git diff --quiet origin/dev..HEAD; then
            git push origin dev
          fi
          echo "merged=true" >> "$GITHUB_OUTPUT"

      - name: Open back-merge PR main → dev (if not exists)
        if: steps.backmerge.outputs.merged != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = 'main';
            const base = 'dev';
            const version = process.env.VERSION || '${{ steps.read_toml.outputs.value }}';
            const title = `chore: back-merge v${version} into dev`;
            const list = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${head}`, base });
            if (list.data.length > 0) {
              core.info('Back-merge PR already exists.');
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, head, base, title, body: `Automated back-merge after releasing v${version} to main.` });
              core.info(`Created PR #${pr.data.number}`);
            }

      - name: Close release → dev PR (if exists)
        if: steps.backmerge.outputs.merged != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const releaseHead = context.payload.pull_request.head.ref; // e.g., release-3.0.3
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${releaseHead}`, base: 'dev' });
            for (const pr of prs.data) {
              await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body: 'Closing in favor of automatic main → dev back-merge after release.' });
              await github.rest.pulls.update({ owner, repo, pull_number: pr.number, state: 'closed' });
              core.info(`Closed PR #${pr.number}`);
            }
