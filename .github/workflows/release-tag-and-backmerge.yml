name: release-tag-and-backmerge

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  tag-and-backmerge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }} # 使用 PAT 以触发其他 workflows

      - name: TOML Reader
        id: read_toml
        uses: SebRollen/toml-action@v1.2.0
        with:
          file: Cargo.toml
          field: package.version

      - name: Create and push tag
        env:
          VERSION: ${{ steps.read_toml.outputs.value }}
          GH_TOKEN: ${{ secrets.PAT_TOKEN }} # 使用 PAT 推送 tag
        shell: bash
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          tag="v${VERSION}"
          echo "Creating tag $tag"
          git tag -a "$tag" -m "Release $VERSION" -f
          # 使用 PAT 推送，这样会触发 release.yml
          git push --force "https://${GITHUB_ACTOR}:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$tag"

      - name: Back-merge main → dev via git merge
        id: backmerge
        shell: bash
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git checkout dev
          git merge main --no-ff -m "chore: back-merge main → dev after release"
